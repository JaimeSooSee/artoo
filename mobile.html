<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9"/>
	<meta name="apple-mobile-web-app-capable" content="yes"/>
	<meta name="viewport" content="user-scalable=no, width=device-width", height=device-height/>
	<link rel="apple-touch-icon" href="artoo_icon.png"/>
	<script type="text/javascript" src="/webiopi.js"></script>
	<script type="text/javascript" src="motor.js"></script>
	<script type="text/javascript" src="artoo.js"></script>
	
	<title>Artoo Controller</title>
      
	<style>
		.box
		{
			width: 100%;
			height: 600px;
			padding: 0px;
			margin: 0px;
			border: 0px solid orange;
			
		}
		body
		{
			margin: 0px;
			background: url("starfield.jpg");
		}
		.topMenu
		{
			height: 1px;
			padding: 1px;
			background: black;
		}
		h3
		{
			color: yellow;
			padding-left: 10px;
		}
	</style>

	<script>

	        webiopi().ready(function() {
			webiopi().refreshGPIO(false);
		});


		function BlockMove(event) {
		    event.preventDefault();
		}

		function isContained(m, e) {
		    var e = e || window.event;
		    var c = /(click)|(mousedown)|(mouseup)/i.test(e.type) ? e.target : (e.relatedTarget || ((e.type == "mouseover") ? e.fromElement : e.toElement));
		    while (c && c != m) try {
		        c = c.parentNode;
		    } catch (e) {
		        c = m;
		    }
		    if (c == m)
		        return true;
		    else
		        return false;
		}

		function moveForward()
	        {
			var statusdiv = document.getElementById('statusdiv');
			statusdiv.innerHTML = 'Status: Move Forward';
			r2d2().moveForward();
	        }

	        function moveBackward()
		{
			var statusdiv = document.getElementById('statusdiv');
			statusdiv.innerHTML = 'Status: Move Backward';
			r2d2().moveBackward();
		}        

	        function turnLeft()
	        {
			var statusdiv = document.getElementById('statusdiv');
			statusdiv.innerHTML = 'Status: Turn Left';
			r2d2().turnLeft();
	        }
	        
	        function turnRight()
	        {
			var statusdiv = document.getElementById('statusdiv');
			statusdiv.innerHTML = 'Status: Turn Right';
			r2d2().turnRight();
	        }        
	        
	        function stop()
	        {
			var statusdiv = document.getElementById('statusdiv');
	          	statusdiv.innerHTML = 'Status: Stop';
			r2d2().stop();
		}

		window.addEventListener('load', function () {
		    var box1 = document.getElementById('box1');

		    var statusdiv = document.getElementById('statusdiv');
		    var startx = 0;
		    var starty = 0;
		    var dist = 0;
		    var moving = false;
		    var detecttouch = !! ('ontouchstart' in window) || !! ('ontouchstart' in document.documentElement) || !! window.ontouchstart || !! window.Touch || !! window.onmsgesturechange || (window.DocumentTouch && window.document instanceof window.DocumentTouch);
		    var ismousedown = false;

		    box1.addEventListener('touchstart', function (e) {
		        var touchobj = e.changedTouches[0]; // reference first touch point (ie: first finger)
		        startx = touchobj.clientX;
		        starty = touchobj.clientY;
		        e.preventDefault();
		    }, false)

		    box1.addEventListener('touchmove', function (e) {
		        if (!moving) {
		            var touchobj = e.changedTouches[0]; // reference first touch point (ie: first finger)
		            var distX = touchobj.clientX - startx;
		            var distY = touchobj.clientY - starty;
		            if (distX >= 100) {
				turnRight();
		                moving = true;
		            } else if (distX <= -100) {
				turnLeft();
		                moving = true;
		            } else if (distY >= 100) {
		                moveBackward();
				moving = true;
		            } else if (distY <= -100) {
		                moveForward();
		                moving = true;
		            }

		            e.preventDefault();
		        }
		    }, false)

		    box1.addEventListener('touchend', function (e) {
		        var touchobj = e.changedTouches[0]; // reference first touch point (ie: first finger)
		        if (moving) {
		            stop();
		        }
		        moving = false;
		        e.preventDefault();
		    }, false)

		    if (!detecttouch) {
		        document.body.addEventListener('mousedown', function (e) {
		            if (isContained(box1, e)) {
		                var touchobj = e;
		                ismousedown = true;
		                startx = parseInt(touchobj.clientX);
		                starty = parseInt(touchobj.clientY);
		                e.preventDefault();
		            }
		        }, false)

		        document.body.addEventListener('mousemove', function (e) {
		            if (ismousedown) {
		                var touchobj = e;
		                var distX = parseInt(touchobj.clientX) - startx;
		                var distY = parseInt(touchobj.clientY) - starty;
		                if (!moving) {
		                    if (distX >= 100) {
		                        turnRight();
		                        moving = true;
		                    } else if (distX <= -100) {
		                        turnLeft();
		                        moving = true;
		                    } else if (distY >= 100) {
		                        moveBackward();
		                        moving = true;
		                    } else if (distY <= -100) {
		                        moveForward();
		                        moving = true;
		                    }
		                }
		                e.preventDefault();
		            }
		        }, false)

		        document.body.addEventListener('mouseup', function (e) {
		            var touchobj = e;
		            ismousedown = false;
		            statusdiv.innerHTML = 'Status: touchend<br /> Resting x coordinate: ' + touchobj.clientX + 'px';
		            statusdiv.innerHTML = 'Status: Stop';
				stop();

		            moving = false;
		            e.preventDefault();
		        }, false)
		    }
		}, false)
	</script>

</head>

<body ontouchmove="BlockMove(event);">
<div class="topMenu" foreground="yellow">
	<!--<button>[x]</button>-->
</div>
<div class="box" id="box1">
  <h3 id="statusdiv">Status: Stop</h3>
</div>

</body>
</html>